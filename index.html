<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>小组图片拼接</title>
    <link rel="stylesheet" href="/static/picocss/css/pico.css">
    <link rel="stylesheet" href="/static/main.css">
    <script src="/static/main.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script async defer data-website-id="04463641-ed4b-4d0f-af66-c66dec1b5d94" src="https://ana.evax.top/umami.js"
            id="umami-js"></script>
</head>
<body>

<main class="container">
    <h1>小组图片拼接</h1>
    <!-- 选择7人或8人 -->
    <form name="numForm" id="numForm">
        <fieldset id="num_choice">
            <legend>选择人数</legend>
            <label><input type="radio" name="num" value="7"
                          checked>7人</label>
            <label><input type="radio" name="num"
                          value="8">8人</label>
        </fieldset>
        <fieldset>
            <legend>添加图片</legend>
            <label>额外文字(可选)<input type="text" name="text"
                                        class="umami--click--change-text"
                                        placeholder="张三 06:30"></label>
            <label><input type="checkbox" name="fix" disabled>覆盖上一张</label>
            <label><input type="file" name="file" accept="image/*"></label>
        </fieldset>
    </form>
    <button id="btn">生成</button>

    <article>
        <canvas id="canvas"></canvas>
    </article>
    <button id="btn2">生成</button>

    <script>
        window.onload = function () {
            const num = document.forms['numForm'].num.value;
            initCanvas(parseInt(num));
            umami.trackEvent("Init Canvas", {num: num});
        }
        // 监听 7人或8人 的选择
        document.forms['numForm'].num.forEach((item) => {
            item.addEventListener('change', (e) => {
                initCanvas(parseInt(e.target.value));
                umami.trackEvent("Change Num to" + e.target.value, {num: e.target.value});
                umami.trackEvent("Init Canvas", {num: e.target.value});
            });
        });
        document.forms['numForm'].fix.addEventListener('change', (e) => {
            if (CanvasData.drawn===0){
                e.target.checked = false;
                e.target.disabled = true;
            } else {
                umami.trackEvent("Change Fix to" + e.target.checked, {fix: e.target.checked});
                e.target.disabled = false;
            }
        });
        document.forms['numForm'].file.addEventListener('change', (e) => {
            const text = document.forms['numForm'].text.value;
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function () {
                const img = new Image();
                // noinspection JSValidateTypes
                img.src = reader.result;
                img.onload = function () {
                    if (document.forms['numForm'].fix.checked && CanvasData.drawn > 0) {
                        CanvasData.drawn--;
                    }
                    drawPic(img, text);
                    e.target.value = '';
                    document.forms['numForm'].text.value = '';
                    document.forms['numForm'].fix.checked = false;
                    umami.trackEvent("Add One Picture", {text: text, num: CanvasData.num, index: CanvasData.drawn});
                }
            }
            document.forms['numForm'].fix.disabled = false;
        });
        document.getElementById("btn").addEventListener('click', () => {
            download()
            umami.trackEvent("Download Picture", {num: CanvasData.num, drawn: CanvasData.drawn});
        })
        document.getElementById("btn2").addEventListener('click', () => {
            download()
            umami.trackEvent("Download Picture", {num: CanvasData.num, drawn: CanvasData.drawn});
        })
    </script>

    <footer>
        <p>Open Source on <a href="https://github.com/gggxbbb/simpleImageStitching">Github</a></p>
        <p>Deployed on Cloudflare Pages</p>
    </footer>
</main>

</body>
</html>
